{% extends "profile_base.html" %} {% block profile_content %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/profile_style.css') }}">

<div class="profile-container">
    <h2>Personal Profile</h2>

    <div class="profile-header">
        <div class="profile-pic-container">
            <img id="profileImage" src="{{ profile_data.profile_pic_url or url_for('static', filename='images/default_avatar.png') }}" alt="Profile Picture">
            <form id="uploadForm" action="MICROSERVICE_UPLOAD_URL/{{ profile_data.student_id }}/picture" method="post" enctype="multipart/form-data" target="upload_iframe">
                 <label for="photoUpload" class="upload-button">Change Photo</label>
                 <input type="file" id="photoUpload" name="photo" accept="image/*" onchange="submitUploadForm();">
                 <input type="hidden" name="api_key" value="your_main_app_key_here"> </form>
             <iframe name="upload_iframe" style="display: none;"></iframe>
            <small>Only .png, .jpg, .jpeg, .gif allowed.</small>
             <div id="uploadStatus"></div> </div>
        <div class="profile-main-info">
             <h3>{{ profile_data.first_name or 'N/A' }} {{ profile_data.last_name or 'N/A' }}</h3>
             <p>{{ profile_data.program or 'N/A' }}</p>
             <p>{{ profile_data.student_id or 'N/A' }}</p>
        </div>
    </div>

    <div class="profile-section">
        <h4>Contact Information</h4>
        <p><strong>Email:</strong> {{ profile_data.email or 'N/A' }}</p>
        <p><strong>Phone:</strong> {{ profile_data.phone or 'N/A' }}</p>
    </div>

     <div class="profile-section">
        <h4>Personal Details</h4>
        <p><strong>Date of Birth:</strong> {{ profile_data.dob or 'N/A' }}</p>
        <p><strong>Gender:</strong> {{ profile_data.gender or 'N/A' }}</p>
        <p><strong>Citizenship:</strong> {{ profile_data.citizenship or 'N/A' }}</p>
    </div>

     <div class="profile-section">
        <h4>Academic Details</h4>
         <p><strong>Student Level:</strong> {{ profile_data.student_level or 'N/A' }}</p>
         <p><strong>Campus:</strong> {{ profile_data.student_campus or 'N/A' }}</p>
    </div>

    <div class="profile-section">
        <h4>Address</h4>
        <p><strong>Street:</strong> {{ profile_data.address.street or 'N/A' }}</p>
        <p><strong>City:</strong> {{ profile_data.address.city or 'N/A' }}</p>
        </div>

      <div class="profile-section">
         <h4>Passport & Visa</h4>
         <p><strong>Passport Number:</strong> {{ profile_data.passport_visa.passport_number or 'N/A' }}</p>
         <p><strong>Visa Status:</strong> {{ profile_data.passport_visa.visa_status or 'N/A' }}</p>
          </div>


    <div class="verify-notice">
        <p><strong>Please Verify</strong></p>
        <p>If the information above is incorrect, please contact the Student Administrative Services Office, providing the appropriate documentary evidence.</p>
    </div>

</div>

<script>
    function submitUploadForm() {
        // Optional: Add client-side validation (file size, type) here
        const form = document.getElementById('uploadForm');
        const statusDiv = document.getElementById('uploadStatus');
        statusDiv.textContent = 'Uploading...';

        // The form targets the iframe, so submission happens in the background.
        // We need to listen to the iframe's load event to know when it's done.
        const iframe = document.querySelector('iframe[name="upload_iframe"]');
        iframe.onload = function() {
             try {
                 // Try to access the iframe's content
                 const iframeDoc = iframe.contentWindow.document;
                 const responseText = iframeDoc.body.textContent || iframeDoc.body.innerText;
                 const response = JSON.parse(responseText);

                 if (response.profile_pic_url) {
                    // Update the image source on the page
                    document.getElementById('profileImage').src = response.profile_pic_url + '?t=' + new Date().getTime(); // Add timestamp to bust cache
                    statusDiv.textContent = 'Upload successful!';
                    statusDiv.style.color = 'green';
                     // Optionally update the main header icon too
                     updateHeaderIcon(response.profile_pic_url);
                 } else if (response.error) {
                     statusDiv.textContent = 'Error: ' + response.error;
                     statusDiv.style.color = 'red';
                 } else {
                    statusDiv.textContent = 'Upload finished. Unknown response.';
                    statusDiv.style.color = 'orange';
                 }
             } catch (e) {
                 console.error("Error processing upload response:", e);
                 statusDiv.textContent = 'Upload failed or blocked by CORS.';
                 statusDiv.style.color = 'red';
             }
             // Clear the file input for potential re-upload
             document.getElementById('photoUpload').value = '';
        };
         form.submit();
    }

    function updateHeaderIcon(newIconUrl) {
        // Find the profile icon element in your main header and update its src
        const headerIcon = document.querySelector('.header-profile-icon img'); // Adjust selector as needed
        if (headerIcon) {
            headerIcon.src = newIconUrl + '?t=' + new Date().getTime();
        }
    }
</script>
{% endblock %}