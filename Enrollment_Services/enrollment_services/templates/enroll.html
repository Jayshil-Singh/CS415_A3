<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Course Enrollment - USP Enrollment System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        .flash-message {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }

        .flash-success {
            background-color: #d1fae5;
            color: #065f46;
        }

        .flash-error {
            background-color: #fee2e2;
            color: #991b1b;
        }

        .flash-info {
            background-color: #dbeafe;
            color: #1e40af;
        }

        .loading-spinner-container {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, .1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            /* indigo-600 */
            animation: spin 1s ease infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .course-prereq-met {
            color: green;
        }

        .course-prereq-unmet {
            color: red;
            font-weight: bold;
        }

        .course-disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            /* Hidden by default */
            position: fixed;
            /* Stay in place */
            z-index: 10;
            /* Sit on top */
            left: 0;
            top: 0;
            width: 100%;
            /* Full width */
            height: 100%;
            /* Full height */
            background-color: rgba(0, 0, 0, 0.4);
            /* Black w/ opacity */
            overflow: auto;
            /* Enable scroll if needed */
        }

        .modal-content {
            background-color: #fefefe;
            margin: 15% auto;
            /* 15% from the top and centered */
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            /* Could be more or less, depending on screen size */
            border-radius: 0.5rem;
            box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.2);
            position: relative;
            text-align: center;
        }

        .modal-header {
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 1rem;
        }

        .modal-body {
            padding: 1.25rem 0;
        }

        .modal-footer {
            padding-top: 1rem;
            border-top: 1px solid #e5e7eb;
            text-align: right;
        }

        .modal-button {
            padding: 0.625rem 1.25rem;
            margin-left: 0.625rem;
            border: none;
            border-radius: 0.3125rem;
            cursor: pointer;
            font-weight: 600;
        }

        .modal-button.confirm {
            background-color: #dc2626;
            /* red-600 */
            color: white;
        }

        .modal-button.cancel {
            background-color: #6b7280;
            /* gray-500 */
            color: white;
        }
    </style>
</head>

<body class="bg-gray-100">
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <a href="{{ url_for('enrollment.dashboard') }}" class="flex-shrink-0">
                        <img class="h-10 w-auto" src="https://placehold.co/150x50/003366/FFFFFF?text=USP+Enroll"
                            alt="USP Logo">
                    </a>
                    <div class="hidden md:block">
                        <div class="ml-10 flex items-baseline space-x-4">
                            <a href="{{ url_for('enrollment.dashboard') }}"
                                class="text-gray-700 hover:bg-indigo-500 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Dashboard</a>
                            <a href="{{ url_for('enrollment.enroll') }}"
                                class="bg-indigo-600 text-white px-3 py-2 rounded-md text-sm font-medium"
                                aria-current="page">Enroll</a>
                            <a href="{{ url_for('enrollment.display_courses') }}"
                                class="text-gray-700 hover:bg-indigo-500 hover:text-white px-3 py-2 rounded-md text-sm font-medium">My
                                Enrollment</a>
                            <a href="{{ url_for('enrollment.fees') }}"
                                class="text-gray-700 hover:bg-indigo-500 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Fees</a>
                            <a href="programmes.html"
                                class="text-gray-700 hover:bg-indigo-500 hover:text-white px-3 py-2 rounded-md text-sm font-medium">Programmes</a>
                        </div>
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="ml-4 flex items-center md:ml-6">
                        <a href="profile.html"
                            class="p-1 rounded-full text-gray-500 hover:text-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white"
                            title="Profile">
                            <span class="sr-only">View profile</span>
                            <i class="fas fa-user-circle fa-lg"></i>
                        </a>
                        <a href="login.html"
                            class="ml-3 inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500">
                            <i class="fas fa-sign-out-alt mr-2"></i>Logout
                        </a>
                    </div>
                </div>
                <div class="-mr-2 flex md:hidden">
                    <button type="button" id="mobile-menu-button"
                        class="bg-gray-50 inline-flex items-center justify-center p-2 rounded-md text-gray-600 hover:text-white hover:bg-indigo-500 focus:outline-none focus:ring-2 focus:ring-inset focus:ring-white"
                        aria-controls="mobile-menu" aria-expanded="false">
                        <span class="sr-only">Open main menu</span>
                        <i class="fas fa-bars fa-lg"></i>
                    </button>
                </div>
            </div>
        </div>
        <div class="md:hidden hidden" id="mobile-menu">
            <div class="px-2 pt-2 pb-3 space-y-1 sm:px-3">
                <a href="{{ url_for('enrollment.dashboard') }}"
                    class="text-gray-700 hover:bg-indigo-500 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Dashboard</a>
                <a href="{{ url_for('enrollment.enroll') }}"
                    class="bg-indigo-600 text-white block px-3 py-2 rounded-md text-base font-medium"
                    aria-current="page">Enroll</a>
                <a href="{{ url_for('enrollment.display_courses') }}"
                    class="text-gray-700 hover:bg-indigo-500 hover:text-white block px-3 py-2 rounded-md text-base font-medium">My
                    Enrollment</a>
                <a href="{{ url_for('enrollment.fees') }}"
                    class="text-gray-700 hover:bg-indigo-500 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Fees</a>
                <a href="programmes.html"
                    class="text-gray-700 hover:bg-indigo-500 hover:text-white block px-3 py-2 rounded-md text-base font-medium">Programmes</a>
            </div>
            <div class="pt-4 pb-3 border-t border-gray-200">
                <div class="flex items-center px-5">
                    <div class="flex-shrink-0">
                        <img class="h-10 w-10 rounded-full" src="https://placehold.co/40x40/E0E0E0/757575?text=S"
                            alt="User Avatar">
                    </div>
                    <div class="ml-3">
                        <div class="text-base font-medium leading-none text-gray-800">Ratu Epeli Nailatikau</div>
                        <div class="text-sm font-medium leading-none text-gray-500">s11223344@student.usp.ac.fj</div>
                    </div>
                </div>
                <div class="mt-3 px-2 space-y-1">
                    <a href="profile.html"
                        class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-indigo-500 hover:text-white"><i
                            class="fas fa-user-edit mr-2"></i>Your Profile</a>
                    <a href="login.html"
                        class="block px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-indigo-500 hover:text-white"><i
                            class="fas fa-sign-out-alt mr-2"></i>Sign out</a>
                </div>
            </div>
        </div>
    </nav>

    <header class="bg-white shadow-sm">
        <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8">
            <h1 class="text-2xl font-semibold text-gray-900">Course Enrollment</h1>
        </div>
    </header>

    <main>
        <div class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="bg-white p-6 rounded-lg shadow-md">
                {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                <div class="space-y-2 mb-4">
                    {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">
                        {{ message }}
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
                {% endwith %}

                <div class="mb-6">
                    <label for="semester" class="block text-sm font-medium text-gray-700 mb-1">Select Semester:</label>
                    <select id="semester" name="semester"
                        class="w-full md:w-1/2 lg:w-1/3 px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm bg-white">
                        <option value="sem2_2025">Semester 2, 2025</option>
                    </select>
                    <p class="text-sm text-gray-500 mt-2">Courses will load based on your programme and selected
                        semester.</p>
                </div>

                <div id="loading-courses" class="loading-spinner-container hidden">
                    <div class="loading-spinner"></div>
                    <p class="ml-3 text-gray-600">Loading courses...</p>
                </div>

                <div id="course-list-container">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Available Courses for Bachelor of Science in
                        Computer Science</h3>
                    <p class="mb-4 text-sm text-indigo-600"><i class="fas fa-info-circle mr-1"></i> You can select a
                        maximum of 4 courses.</p>

                    <form id="enrollment-form" action="{{ url_for('enrollment.enroll') }}" method="POST">
                        <div class="space-y-4">
                            {% for course in courses %}
                            <div
                                class="p-4 border rounded-lg hover:shadow-md transition-shadow 
                                {% if not course.prereq_met or course.already_enrolled %}course-disabled{% endif %}">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h4 class="font-semibold text-lg text-gray-800">{{ course.code }}: {{ course.title
                                            }}</h4>
                                        <p class="text-sm text-gray-500">{{ course.description }}</p>
                                    </div>
                                    <input type="checkbox" name="courses" value="{{ course.code }}"
                                        class="h-5 w-5 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 course-checkbox"
                                        {% if not course.prereq_met or course.already_enrolled %}disabled{% endif %}>
                                </div>
                                <p class="text-xs mt-1">
                                    Prerequisites:
                                    {% if course.prerequisites %}
                                    {{ ', '.join(course.prerequisites) }}
                                    {% if course.prereq_met %}
                                    <span class="course-prereq-met"> (<i class="fas fa-check-circle mr-1"></i>Met)</span>
                                    {% else %}
                                    <span class="course-prereq-unmet"> (<i class="fas fa-times-circle mr-1"></i>Not
                                        Met)</span>
                                    {% endif %}
                                    {% else %}
                                    None
                                    {% endif %}
                                </p>
                                {% if course.already_enrolled %}
                                    <p class="text-xs mt-1 text-blue-600">Already Enrolled</p>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>

                        <div class="mt-8 text-right">
                            <p class="text-sm text-gray-600 mb-2">Selected courses: <span id="selected-count">0</span>/4
                            </p>
                            <button type="button" id="enroll-button"
                                class="inline-flex items-center px-6 py-3 border border-transparent text-base font-medium rounded-lg shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:opacity-50"
                                disabled> <i class="fas fa-check-circle mr-2"></i>Enroll in Selected Courses
                            </button>
                        </div>

                        <div id="enrollConfirmationModal" class="modal-overlay">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3>Confirm Enrollment</h3>
                                </div>
                                <div class="modal-body">
                                    <p>Are you sure you want to enroll in the selected courses?</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="modal-button cancel" id="cancelEnroll">Cancel</button>
                                    <button type="button" class="modal-button confirm" id="confirmEnroll">Enroll</button>
                                </div>
                            </div>
                        </div>

                    </form>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-white border-t mt-12">
        <div class="max-w-7xl mx-auto py-6 px-4 sm:px-6 lg:px-8 text-center text-gray-500 text-sm">
            &copy;
            <script>
                document.write(new Date().getFullYear())
            </script>
            USP Enrollment System. All rights reserved.
        </div>
    </footer>
    <script>
        // Basic mobile menu toggle
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenuButton && mobileMenu) {
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
        }

        // Course selection limit and button enable/disable
        const checkboxes = document.querySelectorAll('.course-checkbox');
        const selectedCountSpan = document.getElementById('selected-count');
        const enrollButton = document.getElementById('enroll-button');
        const enrollConfirmationModal = document.getElementById('enrollConfirmationModal');
        const cancelEnrollButton = document.getElementById('cancelEnroll');
        const confirmEnrollButton = document.getElementById('confirmEnroll');
        const maxCourses = 4;

        function updateSelectedCount() {
            const checkedCount = document.querySelectorAll('.course-checkbox:checked').length;
            selectedCountSpan.textContent = checkedCount;

            if (checkedCount > 0 && checkedCount <= maxCourses) {
                enrollButton.disabled = false;
                enrollButton.classList.remove('disabled:opacity-50');
            } else {
                enrollButton.disabled = true;
                enrollButton.classList.add('disabled:opacity-50');
            }
        }

        checkboxes.forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const checkedCount = document.querySelectorAll('.course-checkbox:checked').length;
                if (checkedCount > maxCourses) {
                    alert(`You can select a maximum of ${maxCourses} courses.`);
                    checkbox.checked = false; // Revert the last check
                }
                updateSelectedCount(); // Update count and button state
            });
        });

        // Initialize count and button state on page load
        updateSelectedCount();

        // Show enrollment confirmation modal
        enrollButton.addEventListener('click', (event) => {
            event.preventDefault(); // Prevent immediate form submission
            enrollConfirmationModal.style.display = 'block';
        });

        // Handle cancel enrollment
        cancelEnrollButton.addEventListener('click', () => {
            enrollConfirmationModal.style.display = 'none';
        });

        // Handle confirm enrollment
        confirmEnrollButton.addEventListener('click', () => {
            enrollConfirmationModal.style.display = 'none';
            document.getElementById('enrollment-form').submit(); // Submit the form
        });

        // The semester selection loading simulation is commented out as it's not needed with direct DB interaction
        // document.getElementById('semester').addEventListener('change', () => {
        //     document.getElementById('course-list-container').classList.add('hidden');
        //     document.getElementById('loading-courses').classList.remove('hidden');
        //     setTimeout(() => {
        //         document.getElementById('loading-courses').classList.add('hidden');
        //         document.getElementById('course-list-container').classList.remove('hidden');
        //         // Here you would dynamically update the course list based on the selected semester
        //         // This would likely involve fetching data from your microservice.
        //         // For now, we'll just keep the existing list.
        //         // You might need to reset checkboxes and counts here as well.
        //     }, 1500);
        // });
    </script>
</body>

</html>